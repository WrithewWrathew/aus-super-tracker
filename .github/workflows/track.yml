name: AusSuper Tracker
on:
  schedule:
    - cron: '*/10 * * * *'  # Every 10 minutes (safer)
  workflow_dispatch:

jobs:
  track:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Fetch CSV (with retries)
      run: |
        for i in {1..5}; do
          echo "Attempt $i/5..."
          curl -s -L --http1.1 \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            --max-time 60 \
            "https://www.australiansuper.com//api/graphs/dailyrates/download/?start=01/02/2026&end=08/02/2026&cumulative=False&superType=super&truncateDecimalPlaces=True&outputFilename=temp.csv" \
            -o temp.csv && break
          sleep 5
        done
        if [ ! -s temp.csv ]; then
          echo "❌ Failed to download CSV after 5 attempts"
          exit 1
        fi
        echo "✅ CSV downloaded ($(wc -c < temp.csv) bytes)"
        head -5 temp.csv
    
    - name: Parse CSV
      run: |
        echo "CSV preview:"
        cat temp.csv | head -3
        
        node -e "
        const fs = require('fs');
        const lines = fs.readFileSync('temp.csv', 'utf8').split('\n');
        if (lines.length < 2) {
          console.log('❌ No data rows');
          process.exit(1);
        }
        
        const headers = lines[0].split(',').map(h => h.trim().replace(/[\"]/g, ''));
        console.log('Headers:', headers.join(' | '));
        
        const intlIndex = headers.indexOf('International Shares');
        if (intlIndex === -1) {
          console.log('❌ No International Shares column');
          process.exit(1);
        }
        console.log('✅ International Shares at column', intlIndex);
        
        let intlValue = 0;
        for (let i = lines.length - 1; i > 0; i--) {
          if (!lines[i].trim()) continue;
          const cols = lines[i].split(',').map(c => c.trim());
          if (cols.length > intlIndex) {
            const value = parseFloat(cols[intlIndex]);
            if (!isNaN(value) && Math.abs(value) > 0.0001) {
              intlValue = value;
              break;
            }
          }
        }
        
        const data = {
          value: intlValue.toFixed(4),
          timestamp: new Date().toISOString(),
          rawHeaders: headers
        };
        fs.writeFileSync('data.json', JSON.stringify(data, null, 2));
        console.log('✅ Saved:', data.value + '%');
        "
    
    - name: Commit data
      run: |
        git config user.name "AusSuper Bot"
        git config user.email "action@github.com"
        git add data.json temp.csv
        git commit -m "Update: $(node -p \"require('./data.json').value\")%" || echo "No changes"
        git push
